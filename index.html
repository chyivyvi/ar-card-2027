<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .ui-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 15px; width: 90%;
        }
        .button-group { display: flex; gap: 10px; justify-content: center; }
        button {
            padding: 12px 20px; font-size: 16px; cursor: pointer;
            background: white; border: 2px solid #ffcccc; border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .confirm-btn { background-color: #ffcccc; font-weight: bold; }
        .action-btn { background-color: #e0f7fa; border-color: #b2ebf2; }
        .step-hint { background: rgba(0,0,0,0.6); color: white; padding: 8px 20px; border-radius: 20px; font-size: 14px; }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div class="ui-container">
        <div id="hint" class="step-hint">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡èƒŒæ™¯è£é£¾</div>
        
        <div id="step1-btns" class="button-group">
            <button onclick="selectLayer('deco', 'heart')">â¤ æ„›å¿ƒ</button>
            <button onclick="selectLayer('deco', 'star')">â­ æ˜Ÿæ˜Ÿ</button>
            <button class="confirm-btn" onclick="nextStep(2)">ä¸‹ä¸€å€‹ âœ”</button>
        </div>

        <div id="step2-btns" class="button-group" style="display: none;">
            <button onclick="backToStep1()">â¬… è¿”å›</button>
            <button onclick="selectLayer('ribbon', 'ribbon_a')">ğŸ€ ç·å¸¶</button>
            <button onclick="selectLayer('ribbon', 'bow')">ğŸ è´è¶çµ</button>
            <button class="confirm-btn" onclick="nextStep(3)">å®Œæˆ âœ”</button>
        </div>

        <div id="step3-btns" class="button-group" style="display: none;">
            <button class="action-btn" onclick="enterPhotoMode(event)">ğŸ“¸ éš±è—ä»‹é¢åˆç…§</button>
            <button onclick="resetGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
         </div>
    </div>

    <a-scene embedded arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; patternRatio: 0.5;" renderer="preserveDrawingBuffer: true;">
        <a-marker type="pattern" url="./pattern-sheep.patt">
            <a-image id="base-sheep" src="sheep.png" position="0 0 0" rotation="-90 0 0" width="1.5" height="1.5"></a-image>

            <a-image id="layer-heart" src="heart.png" position="0 0.1 0" rotation="-90 0 0" width="1.5" height="1.5" visible="false"
                     animation="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; dur: 600; loop: true; easing: easeInOutSine"></a-image>
            <a-image id="layer-star" src="star.png" position="0 0.1 0" rotation="-90 0 0" width="1.5" height="1.5" visible="false"
                     animation="property: rotation; from: -90 0 0; to: -90 360 0; dur: 5000; loop: true; easing: linear"></a-image>

            <a-image id="layer-ribbon_a" src="ribbon.png" position="0 0.2 0" rotation="-90 0 0" width="1.5" height="1.5" visible="false"></a-image>
            <a-image id="layer-bow" src="bow.png" position="0 0.2 0" rotation="-90 0 0" width="1.5" height="1.5" visible="false"></a-image>

            <a-gltf-model id="layer-3d" 
              src="test.glb?v=3" 
              position="-0.8 0.3 0" 
              scale="0.2 0.2 0.2" 
              rotation="-90 0 0" 
              visible="false"
              animation="property: rotation; from: -90 0 0; to: -90 0 360; loop: true; dur: 5000; easing: linear">
            </a-gltf-model>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        function selectLayer(group, item) {
            if (group === 'deco') {
                document.querySelector('#layer-heart').setAttribute('visible', item === 'heart');
                document.querySelector('#layer-star').setAttribute('visible', item === 'star');
            } else if (group === 'ribbon') {
                document.querySelector('#layer-ribbon_a').setAttribute('visible', item === 'ribbon_a');
                document.querySelector('#layer-bow').setAttribute('visible', item === 'bow');
            }
        }

        function nextStep(step) {
            hideAllUI();
            if (step === 2) {
                document.getElementById('step2-btns').style.display = 'flex';
                document.getElementById('hint').innerText = 'ç¬¬äºŒæ­¥ï¼šåŠ ä¸Šé£¾å“';
            } else if (step === 3) {
                document.getElementById('step3-btns').style.display = 'flex';
                document.getElementById('hint').innerText = 'å¤ªæ£’äº†ï¼å¿«æ‹å¼µç…§åˆ†äº«å§';

                // é¡¯ç¤º 3D æ¨¡å‹
        const model3d = document.querySelector('#layer-3d');
        if(model3d) model3d.setAttribute('visible', 'true');
            }
        }
       // è®“ UI æ¶ˆå¤±
        function hideAllUI() {
            document.getElementById('step1-btns').style.display = 'none';
            document.getElementById('step2-btns').style.display = 'none';
            document.getElementById('step3-btns').style.display = 'none';
        }
        function backToStep1() {
            hideAllUI();
            document.getElementById('step1-btns').style.display = 'flex';
            document.getElementById('hint').innerText = 'ç¬¬ä¸€æ­¥ï¼šé¸æ“‡èƒŒæ™¯è£é£¾';
        }

        // æ‹ç…§éš±è—UIä»‹é¢
    function enterPhotoMode(event) {
    // é˜»æ­¢äº‹ä»¶å‚³çµ¦ windowï¼Œé¿å…ç§’é€Ÿé€€å‡º
    if (event) event.stopPropagation();

    // 1. éš±è— UI å®¹å™¨
    document.querySelector('.ui-container').style.display = 'none';
    
    // 2. ç›£è½å…¨è¢å¹•é»æ“Šäº‹ä»¶ä¾†å–šå›
    // åŠ ä¸Š setTimeout æ˜¯ç‚ºäº†ä¿éšªï¼Œç¢ºä¿é€™æ¬¡çš„é»æ“Šå‹•ä½œå·²ç¶“çµæŸ
    setTimeout(() => {
        window.addEventListener('click', exitPhotoMode, { once: true });
    }, 100);
        document.getElementById('hint').style.display = 'none'; // éš±è—æç¤ºå­—
}

function exitPhotoMode() {
    document.querySelector('.ui-container').style.display = 'flex';
    document.getElementById('hint').style.display = 'block'; // é¡¯ç¤ºæç¤ºå­—
    nextStep(3);
}

    // è®“ UI å›ä¾†
        function exitPhotoMode() {
            // 1. é‡æ–°é¡¯ç¤º UI å®¹å™¨
            document.querySelector('.ui-container').style.display = 'flex';
    
            // 2. ç¢ºä¿å®ƒå›åˆ°ç•¶å‰çš„æ­¥é©Ÿ (Step 3)
        nextStep(3);
        }

        function resetGame() {
    // 1. éš±è—æ‰€æœ‰åœ–å±¤
    const layers = ['#layer-heart', '#layer-star', '#layer-ribbon_a', '#layer-bow', '#layer-3d'];
    layers.forEach(id => {
        const el = document.querySelector(id);
        if (el) {
            el.setAttribute('visible', 'false');
            // é€™è£¡è¦åˆ¤æ–·ï¼šå¦‚æœæ˜¯ 3D æ¨¡å‹å°±å› 0.2ï¼Œå¦‚æœæ˜¯åœ–ç‰‡å°±å› 1
            if (id === '#layer-3d') {
                el.setAttribute('scale', '0.2 0.2 0.2');
            } else {
                el.setAttribute('scale', '1 1 1');
            }
        }
    });
    
    // 2. ç§»é™¤å…¨è¢å¹•é»æ“Šç›£è½å™¨ï¼ˆé˜²æ­¢åœ¨æ‹ç…§æ¨¡å¼ä¸‹æŒ‰å†ç©ä¸€æ¬¡å°è‡´éŒ¯èª¤ï¼‰
    window.removeEventListener('click', exitPhotoMode);
    
    // 3. å›åˆ°ç¬¬ä¸€æ­¥
    backToStep1();
}

        async function takeSnapshot() {
            const scene = document.querySelector('a-scene');
            scene.renderer.render(scene.object3D, scene.camera);
            const canvas = scene.renderer.domElement;

            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            // ä¿®æ­£æ¯”ä¾‹ï¼šä½¿ç”¨é¡¯ç¤ºå¯¬é«˜
            tempCanvas.width = canvas.clientWidth;
            tempCanvas.height = canvas.clientHeight;
            ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

            tempCanvas.toBlob(async (blob) => {
                const file = new File([blob], "AR_Card.png", { type: "image/png" });
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ files: [file], title: 'æˆ‘çš„ AR è³€å¡' });
                    } catch (err) {}
                } else {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'AR_Card.png';
                    link.click();
                }
            }, 'image/png');
        }
    </script>
</body>
</html>










